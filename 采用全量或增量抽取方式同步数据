----------采用全量抽取方式同步appointment表----------
---创建存储过程：
CREATE TABLE APPOINTMENT_UPDATE AS SELECT * FROM APPOINTMENT;
DROP TABLE APPOINTMENT_UPDATE;

CREATE OR REPLACE PROCEDURE UPDATE_APPOINTMENT_FULL
IS
  V_SP_NAME VARCHAR2(100):='UPDATE_APPOINTMENT';
  V_CYCLE_ID NUMBER := SEQ_CYCLE_ID.NEXTVAL;
BEGIN
  SP_LOG(V_SP_NAME,V_CYCLE_ID,1,'开始执行存储过程');
  EXECUTE IMMEDIATE 'TRUNCATE TABLE APPOINTMENT_UPDATE';
  SP_LOG(V_SP_NAME,V_CYCLE_ID,2,'清空appointment表数据');
  INSERT INTO APPOINTMENT_UPDATE SELECT * FROM APPOINTMENT WHERE 1=1;
  SP_LOG(V_SP_NAME,V_CYCLE_ID,3,'全量插入appointment数据到appointment_update表');
  COMMIT;
END;
     

---以上存储过程写好后，可进行调用：
BEGIN
  UPDATE_APPOINTMENT_FULL;
END;

---检查同步后的结果：
SELECT * FROM APPOINTMENT_UPDATE;

---检查日志方便查阅错误和提升效率：
SELECT * FROM LOG_RECORD;


----------采用增量抽取方式同步appointment表，已删除数据保留----------

---源系统表
TRUNCATE TABLE APPOINTMENT_UPDATE;
/*使用ETL工具输入源系统表格*/
ALTER TABLE APPOINTMENT_UPDATE ADD CREATE_DATE DATE; -- 创建时间
ALTER TABLE APPOINTMENT_UPDATE ADD UPDATE_DATE DATE; -- 更新时间

---目标表
CREATE TABLE T_APPOINTMENT_UPDATE AS SELECT * FROM APPOINTMENT;
ALTER TABLE T_APPOINTMENT_UPDATE ADD CREATE_DATE DATE; -- 创建时间
ALTER TABLE T_APPOINTMENT_UPDATE ADD UPDATE_DATE DATE; -- 更新时间
ALTER TABLE T_APPOINTMENT_UPDATE ADD SYN_DATE DATE;  -- 同步时间

---创建存储过程：
CREATE OR REPLACE PROCEDURE UPDATE_APPOINTMENT_ADD （P_START_DATE VARCHAR2,
                                                 P_END_DATE VARCHAR2)
IS
  V_SP_NAME VARCHAR2(100):='UPDATE_APPOINTMENT';
  V_CYCLE_ID NUMBER := SEQ_CYCLE_ID.NEXTVAL;
  V_START_DATE DATE := TO_DATE(P_START_DATE,'YYYY-MM-DD HH24:MI:SS');
  V_END_DATE DATE := TO_DATE(P_END_DATE,'YYYY-MM-DD HH24:MI:SS');
BEGIN
  SP_LOG(V_SP_NAME,V_CYCLE_ID,1,'开始执行存储过程');
  MERGE INTO T_APPOINTMENT_UPDATE A
  USING (SELECT APPOINTMENTID,
  PATIENT,
  PREPNURSE,
  PHYSICIAN,
  START_DT_TIME,
  END_DT_TIME,
  EXAMINATIONROOM,
  CREATE_DATE,
  UPDATE_DATE
   FROM APPOINTMENT_UPDATE
   WHERE UPDATE_DATE>=V_START_DATE
   AND UPDATE_DATE<V_START_DATE
  ) B
  ON A.APPOINTMENTID = B.APPOINTMENTID
  WHEN MATCHED THEN UPDATE SET
  A.PATIENT=B.PATIENT,
  A.PREPNURSE=B.PREPNURSE,
  A.PHYSICIAN=B.PHYSICIAN,
  A.START_DT_TIME=B.START_DT_TIME,
  A.END_DT_TIME=B.END_DT_TIME,
  A.EXAMINATIONROOM=B.EXAMINATIONROOM,
  A.CREATE_DATE=B.CREATE_DATE,
  A.UPDATE_DATE=B.UPDATE_DATE
  WHEN NOT MATCHED THEN INSERT
  A.APPOINTMENTID,
  A.PATIENT,
  A.PREPNURSE,
  A.PHYSICIAN,
  A.START_DT_TIME,
  A.END_DT_TIME,
  A.EXAMINATIONROOM,
  A.CREATE_DATE,
  A.UPDATE_DATE);
  SP_LOG(V_SP_NAME,V_CYCLE_ID,3,'增量插入appointment数据到appointment_update表，已删除数据保留');
  COMMIT;
END;


---以上存储过程写好后，可进行调用：
BEGIN
  UPDATE_APPOINTMENT_ADD(TRUNC(SYSDATE)-1,TRUNC(SYSDATE));
END;

---检查同步后的结果：
SELECT * FROM APPOINTMENT_UPDATE;

---检查日志方便查阅错误和提升效率：
SELECT * FROM LOG_RECORD;
